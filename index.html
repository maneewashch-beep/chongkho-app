<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ä‡∏á‡πÇ‡∏Ñ‡πÄ‡∏Å‡∏°‡∏™‡πå - ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡∏±‡∏á‡∏á‡∏≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); background-image: radial-gradient(circle at 10% 20%, rgb(239, 246, 255) 0%, rgb(255, 241, 242) 90%); }
        h1, h2, h3, .font-heading { font-family: 'Kanit', sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .btn-luxury { background: linear-gradient(90deg, #A78BFA, #818CF8); color: white; transition: all 0.3s ease; }
        .btn-luxury:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(167, 139, 250, 0.3); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        /* Dynamic Theme Colors */
        .theme-admin { @apply bg-red-600 text-white; }
        .theme-purple { @apply bg-purple-500 text-white; }
        .theme-skyblue { @apply bg-sky-400 text-white; }
        .theme-blue { @apply bg-blue-600 text-white; }
        .theme-green { @apply bg-green-500 text-white; }
        .theme-orange { @apply bg-orange-500 text-white; }
        .theme-yellow { @apply bg-yellow-400 text-white; }
        /* Badge Colors */
        .badge-purple { @apply bg-purple-100 text-purple-800 border border-purple-200; }
        .badge-skyblue { @apply bg-sky-100 text-sky-800 border border-sky-200; }
        .badge-blue { @apply bg-blue-100 text-blue-800 border border-blue-200; }
        .badge-green { @apply bg-green-100 text-green-800 border border-green-200; }
        .badge-orange { @apply bg-orange-100 text-orange-800 border border-orange-200; }
        .badge-yellow { @apply bg-yellow-100 text-yellow-800 border border-yellow-200; }
        .badge-admin { @apply bg-gray-800 text-white border border-gray-600; }
    </style>
</head>
<body class="min-h-screen text-slate-600 pb-20 text-sm">
    <div id="app">
        
        <nav v-if="token" class="bg-white p-4 sticky top-0 z-50 shadow-md transition-all duration-500 border-b border-slate-100">
            <div class="container mx-auto flex justify-between items-center px-2">
                <div class="flex items-center gap-3">
                    <img src="png.png" alt="Logo" class="h-10 md:h-12 w-auto drop-shadow-sm">
                    <div class="flex flex-col">
                        <span class="font-heading font-bold text-lg md:text-xl text-black leading-tight">‡∏ä‡∏á‡πÇ‡∏Ñ‡πÄ‡∏Å‡∏°‡∏™‡πå</span>
                        <span class="text-xs text-slate-500">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡∏±‡∏á‡∏á‡∏≤</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <button @click="showProfileMenu = !showProfileMenu" class="flex items-center gap-2 focus:outline-none bg-slate-100 p-1.5 pr-3 rounded-full hover:bg-slate-200 transition border border-slate-200">
                            <img :src="'https://ui-avatars.com/api/?name='+(user.full_name || user.username)+'&background=random'" class="h-8 w-8 rounded-full border border-slate-300 object-cover">
                            <span class="text-black font-bold text-sm hidden md:inline">{{ user.full_name || user.username }}</span>
                            <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        
                        <div v-if="showProfileMenu" class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl py-2 z-50 animate-fade-in-up border border-slate-100">
                            <div class="px-4 py-2 border-b border-slate-100 bg-slate-50">
                                <p class="text-sm font-bold text-slate-800">{{ user.full_name }}</p>
                                <p class="text-xs text-slate-500 capitalize mt-1">{{ getRoleName(user.role) }} <span :class="getBadgeClass(user.color)" class="px-1.5 py-0.5 rounded ml-1 text-[10px]">{{ getColorName(user.color) }}</span></p>
                            </div>
                            <a href="#" @click.prevent="openEditProfile" class="block px-4 py-2 text-sm text-slate-700 hover:bg-purple-50 hover:text-purple-600 transition flex items-center gap-2">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
                            <a href="#" @click.prevent="confirmLogout" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition flex items-center gap-2">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div v-if="!token" class="flex items-center justify-center min-h-screen p-4 relative overflow-hidden">
            <div class="glass-card p-6 md:p-8 rounded-[2rem] shadow-xl w-full max-w-md relative z-10 border-t border-white/60">
                <div class="text-center mb-4">
                    <img src="png.png" alt="Logo" class="h-16 w-auto mx-auto mb-2 drop-shadow-md hover:scale-105 transition duration-500">
                    <h1 class="text-2xl md:text-3xl font-heading font-bold text-slate-800 mb-1">‡∏ä‡∏á‡πÇ‡∏Ñ‡πÄ‡∏Å‡∏°‡∏™‡πå</h1>
                    <p class="text-slate-500 font-light text-xs tracking-widest uppercase">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡∏±‡∏á‡∏á‡∏≤</p>
                </div>
                <div class="flex justify-center mb-4 bg-slate-100/50 p-1 rounded-xl">
                    <button @click="isLoginMode = true" :class="isLoginMode ? 'bg-white shadow-sm text-purple-600' : 'text-slate-400 hover:text-slate-600'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button @click="isLoginMode = false" :class="!isLoginMode ? 'bg-white shadow-sm text-purple-600' : 'text-slate-400 hover:text-slate-600'" class="flex-1 py-2 rounded-lg text-xs font-medium transition-all">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </div>
                <form @submit.prevent="authAction" class="space-y-3">
                    <input v-model="authForm.username" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)" class="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none text-sm focus:ring-2 focus:ring-purple-200 transition" required>
                    <input v-model="authForm.password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)" class="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none text-sm focus:ring-2 focus:ring-purple-200 transition" required>
                    
                    <div v-if="!isLoginMode" class="space-y-3 animate-fade-in-up">
                        <input v-model="authForm.full_name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none text-sm" required>
                        <select v-model="authForm.role" class="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none text-sm text-slate-600" required>
                            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                            <option value="staff">Staff</option>
                            <option value="president">‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏™‡∏µ</option>
                            <option value="vice">‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏™‡∏µ</option>
                            <option value="treasurer">‡πÄ‡∏´‡∏£‡∏±‡∏ç‡∏ç‡∏¥‡∏Å</option>
                            <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                        </select>
                        <select v-if="authForm.role !== 'admin'" v-model="authForm.color" class="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none text-sm text-slate-600" required>
                            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</option>
                            <option value="purple">‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á</option>
                            <option value="skyblue">‡∏™‡∏µ‡∏ü‡πâ‡∏≤</option>
                            <option value="blue">‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option>
                            <option value="green">‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</option>
                            <option value="orange">‡∏™‡∏µ‡πÅ‡∏™‡∏î</option>
                            <option value="yellow">‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full mt-4 btn-luxury font-heading font-bold py-3 rounded-xl shadow-lg text-sm hover:scale-[1.02] active:scale-[0.98] transition">{{ isLoginMode ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' }}</button>
                </form>
            </div>
        </div>

        <div v-else class="container mx-auto p-4 md:p-8 max-w-[95%] xl:max-w-7xl pb-24">
            
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex overflow-x-auto gap-2 pb-1 md:pb-0 scrollbar-hide w-full md:w-auto p-1">
                    <button @click="currentTab = 'members'" :class="currentTab === 'members' ? 'bg-purple-600 text-white shadow-md' : 'bg-white text-slate-500 hover:bg-slate-50'" class="px-6 py-3 rounded-xl text-base font-heading font-bold whitespace-nowrap transition-all flex-1 md:flex-none">üëï ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                    <button v-if="canAccessBudget" @click="currentTab = 'budget'" :class="currentTab === 'budget' ? 'bg-purple-600 text-white shadow-md' : 'bg-white text-slate-500 hover:bg-slate-50'" class="px-6 py-3 rounded-xl text-base font-heading font-bold whitespace-nowrap transition-all flex-1 md:flex-none">üí∞ ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</button>
                    <button v-if="user.role === 'admin'" @click="loadUsers" :class="currentTab === 'users' ? 'bg-purple-600 text-white shadow-md' : 'bg-white text-slate-500 hover:bg-slate-50'" class="px-6 py-3 rounded-xl text-base font-heading font-bold whitespace-nowrap transition-all flex-1 md:flex-none">üëÆ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>

                <div v-if="user.role === 'admin' && currentTab !== 'users'" class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl border border-slate-200 w-full md:w-auto">
                    <span class="font-bold text-slate-700 text-sm pl-2 whitespace-nowrap">‚öôÔ∏è ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</span>
                    <select v-model="adminFilterColor" @change="fetchData(true)" class="py-2 px-4 bg-white rounded-lg text-sm text-slate-600 outline-none border border-slate-200 cursor-pointer w-full md:w-auto">
                        <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="orange">‡∏™‡∏µ‡πÅ‡∏™‡∏î</option>
                        <option value="green">‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</option>
                        <option value="purple">‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á</option>
                        <option value="skyblue">‡∏™‡∏µ‡∏ü‡πâ‡∏≤</option>
                        <option value="blue">‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option>
                        <option value="yellow">‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á</option>
                    </select>
                </div>
            </div>

            <div v-if="currentTab === 'members'" class="animate-fade-in-up">
                <div class="glass-card p-6 md:p-8 rounded-[2rem]">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                            <p class="text-slate-400 text-sm mt-1">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span class="font-bold text-purple-600">{{ filteredMembers.length }}</span> ‡∏Ñ‡∏ô</p>
                        </div>
                        <div class="flex flex-wrap gap-3 w-full md:w-auto">
                            <button @click="generateSummary" class="bg-indigo-500 text-white px-5 py-3 rounded-xl shadow hover:bg-indigo-600 flex items-center justify-center gap-2 text-sm font-bold flex-1 md:flex-none transition">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
                            <button v-if="canEditMembers" @click="openAddMember" class="btn-luxury px-6 py-3 rounded-xl shadow flex items-center justify-center gap-2 text-sm font-bold flex-1 md:flex-none">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                        </div>
                    </div>

                    <div class="flex gap-2 overflow-x-auto pb-4 mb-2 scrollbar-hide">
                        <button @click="levelFilter = 'all'" :class="levelFilter === 'all' ? 'bg-slate-800 text-white shadow-md' : 'bg-white border text-slate-600 hover:bg-slate-50'" class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button v-for="lvl in visibleFilterLevels" :key="lvl.id" @click="levelFilter = lvl.id" :class="levelFilter === lvl.id ? 'bg-slate-800 text-white shadow-md' : 'bg-white border text-slate-600 hover:bg-slate-50'" class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all">{{ lvl.name }}</button>
                    </div>

                    <div v-if="filteredMembers.length > 0 && canEditMembers" class="mb-4 p-4 bg-green-50 rounded-2xl border border-green-100 flex items-center gap-3">
                        <label class="flex items-center gap-2 cursor-pointer select-none">
                            <input type="checkbox" class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500" 
                                   @change="confirmBulkPay(filteredMembers, $event.target.checked)">
                            <span class="font-bold text-green-700">üí∞ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({{ filteredMembers.length }} ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà)</span>
                        </label>
                    </div>

                    <div v-if="Object.keys(groupedMembers).length > 0">
                        <div v-for="(rooms, dept) in groupedMembers" :key="dept" class="mb-8 bg-white/50 rounded-2xl border border-slate-100 p-4 shadow-sm">
                            <h3 class="text-lg md:text-xl font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <span class="bg-purple-100 text-purple-700 p-1.5 rounded-lg text-sm">üè¢</span> {{ dept }}
                                <label v-if="canEditMembers" class="ml-2 flex items-center gap-1 cursor-pointer text-sm font-normal text-slate-500 hover:text-green-600 bg-white border px-2 py-0.5 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4 rounded text-green-600" 
                                           @change="confirmBulkPayObj(rooms, $event.target.checked)">
                                    <span>‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ú‡∏ô‡∏Å</span>
                                </label>
                            </h3>
                            
                            <div v-for="(members, roomKey) in rooms" :key="roomKey" class="mb-4 ml-2 md:ml-4">
                                <h4 class="text-sm md:text-base font-semibold text-slate-600 mb-2 flex items-center gap-2 bg-slate-50 w-fit px-3 py-1 rounded-full border border-slate-200">
                                    <span class="w-2 h-2 rounded-full bg-slate-400"></span> {{ roomKey }}
                                    <span class="text-xs text-slate-400 font-normal">({{ members.length }} ‡∏Ñ‡∏ô)</span>
                                    <label v-if="canEditMembers" class="ml-2 flex items-center gap-1 cursor-pointer hover:text-green-600">
                                        <input type="checkbox" class="w-3 h-3 rounded text-green-600" 
                                               @change="confirmBulkPay(members, $event.target.checked)">
                                        <span class="text-[10px]">‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö</span>
                                    </label>
                                </h4>
                                
                                <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm bg-white">
                                    <table class="w-full text-left min-w-[600px]">
                                        <thead class="bg-slate-50 text-slate-500 text-sm font-bold">
                                            <tr>
                                                <th class="p-3 w-16">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                                <th class="p-3">‡∏™‡∏µ/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th>
                                                <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                                <th class="p-3">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                                                <th class="p-3 text-center">‡πÑ‡∏ã‡∏ï‡πå</th>
                                                <th class="p-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                                <th v-if="canEditMembers" class="p-3 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y text-sm">
                                            <tr v-for="(m, index) in members" :key="m.id" class="hover:bg-purple-50/30 transition">
                                                <td class="p-3 text-center text-slate-400 font-mono">{{ index + 1 }}</td>
                                                <td class="p-3">
                                                    <span :class="getBadgeClass(m.color)" class="px-2 py-0.5 rounded text-[10px] font-bold border">{{ getColorName(m.color) }}</span>
                                                </td>
                                                <td class="p-3 font-medium text-slate-700">{{ m.name }}</td>
                                                <td class="p-3 font-mono text-slate-500">{{ m.student_id }}</td>
                                                <td class="p-3 text-center"><span class="bg-white/80 px-2 py-1 rounded font-bold font-mono border border-slate-200 shadow-sm">{{ m.shirt_size }}</span></td>
                                                <td class="p-3 text-center">
                                                    <div class="flex gap-1 justify-center">
                                                        <span v-if="m.is_paid" class="text-green-600 bg-white/80 px-1.5 py-0.5 rounded text-[10px] font-bold border border-green-200">üí∞ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                                                        <span v-else class="text-red-400 bg-white/80 px-1.5 py-0.5 rounded text-[10px] font-bold border border-red-100">‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢</span>
                                                        <span v-if="m.is_received" class="text-blue-600 bg-white/80 px-1.5 py-0.5 rounded text-[10px] font-bold border border-blue-200">üëï ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
                                                    </div>
                                                </td>
                                                <td v-if="canEditMembers" class="p-3 text-right">
                                                    <div class="flex gap-2 justify-end">
                                                        <button @click="openEditMember(m)" class="text-yellow-600 bg-white/80 p-1.5 rounded-lg hover:bg-yellow-100 border border-yellow-200 transition shadow-sm"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                                                        <button @click="deleteMember(m.id)" class="text-red-500 bg-white/80 p-1.5 rounded-lg hover:bg-red-100 border border-red-200 transition shadow-sm"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else class="p-8 text-center text-slate-400 text-sm bg-slate-50 rounded-2xl border border-slate-100">
                        <span class="text-2xl block mb-2">üì≠</span> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'budget'" class="animate-fade-in-up">
                <div class="glass-card p-6 md:p-8 rounded-[2rem]">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-slate-800">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 p-6 rounded-2xl text-center border border-green-100 shadow-sm"><div class="text-sm text-green-600 font-bold mb-1 uppercase tracking-wide">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div><div class="text-3xl font-bold text-green-700">{{ formatCurrency(totalIncome) }}</div></div>
                        <div class="bg-red-50 p-6 rounded-2xl text-center border border-red-100 shadow-sm"><div class="text-sm text-red-600 font-bold mb-1 uppercase tracking-wide">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div><div class="text-3xl font-bold text-red-700">{{ formatCurrency(totalExpense) }}</div></div>
                        <div class="bg-blue-50 p-6 rounded-2xl text-center border border-blue-100 shadow-sm"><div class="text-sm text-blue-600 font-bold mb-1 uppercase tracking-wide">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div><div class="text-3xl font-bold text-blue-700">{{ formatCurrency(totalIncome - totalExpense) }}</div></div>
                    </div>
                    
                    <div class="flex gap-3 mb-6" v-if="canManageBudget">
                        <button v-if="canSetBudget" @click="openTransactionModal('set_balance')" class="flex-1 bg-teal-500 text-white py-2 px-4 rounded-xl text-xs font-bold shadow hover:bg-teal-600 transition">üí∞ ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
                        <button @click="openTransactionModal('new')" class="flex-[2] btn-luxury py-3 rounded-2xl text-base font-bold shadow transition">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                    <div v-else class="bg-slate-50 p-4 rounded-2xl text-center text-slate-500 text-sm mb-6 border border-slate-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        <span>‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏´‡∏£‡∏±‡∏ç‡∏ç‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏î‡πâ</span>
                    </div>

                    <div class="space-y-3">
                        <div v-for="t in budgetList" :key="t.id" class="flex justify-between items-center bg-white/60 border border-slate-100 rounded-2xl p-5 hover:bg-white transition shadow-sm group">
                            <div class="flex gap-4 items-center">
                                <div :class="t.type === 'income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'" class="w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold shadow-inner">{{ t.type === 'income' ? '‚Üó' : '‚Üò' }}</div>
                                <div>
                                    <div class="text-lg font-bold text-slate-700">{{ t.description }}</div>
                                    <div v-if="user.role === 'admin'" class="text-sm text-slate-400">{{ getColorName(t.color) }}</div>
                                    
                                </div>
                            </div>
                            <div class="flex gap-4 items-center">
                                <span :class="t.type === 'income' ? 'text-green-600' : 'text-red-500'" class="font-bold text-xl">{{ formatCurrency(t.amount) }}</span>
                                <div v-if="canManageBudget" class="flex gap-2">
                                    <button @click="openTransactionModal('edit', t)" class="text-yellow-600 bg-yellow-100 p-2 rounded-xl hover:bg-yellow-200 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                                    <button @click="deleteTransaction(t.id)" class="text-red-600 bg-red-100 p-2 rounded-xl hover:bg-red-200 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'users'" class="animate-fade-in-up">
                <div class="glass-card p-6 rounded-[2rem]">
                    <h2 class="text-2xl font-bold mb-6 text-slate-800">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <div class="overflow-x-auto rounded-2xl border border-slate-100">
                        <table class="w-full text-left min-w-[800px]">
                            <thead class="bg-slate-50 text-slate-500 text-base"><tr><th class="p-4">User</th><th class="p-4">‡∏ä‡∏∑‡πà‡∏≠</th><th class="p-4">Role</th><th class="p-4">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏™‡∏µ</th><th class="p-4">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Hash)</th><th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody class="divide-y text-base">
                                <tr v-for="u in userList" :key="u.id" class="hover:bg-slate-50 transition">
                                    <td class="p-4 font-bold text-purple-600">{{ u.username }}</td>
                                    <td class="p-4">{{ u.full_name }}</td>
                                    <td class="p-4"><span class="bg-slate-100 px-3 py-1 rounded-lg text-sm">{{ getRoleName(u.role) }}</span></td>
                                    <td class="p-4"><span :class="getBadgeClass(u.color)" class="px-3 py-1 rounded-full text-xs font-bold border">{{ getColorName(u.color) }}</span></td>
                                    <td class="p-4 text-xs font-mono text-slate-400 break-all max-w-[120px]">{{ u.password.substring(0, 15) }}...</td>
                                    <td class="p-4 text-center">
                                        <button @click="resetPassword(u.id, u.username)" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-sm hover:bg-slate-700 shadow transition">Reset Password</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showEditProfileModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[60]">
             <div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl animate-fade-in-up">
                <h3 class="text-2xl font-bold mb-6">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                <form @submit.prevent="updateProfile" class="space-y-6">
                    <div class="flex justify-center mb-6">
                        <div class="relative group cursor-pointer" @click="$refs.editAvatar.click()">
                            <img :src="'https://ui-avatars.com/api/?name='+(user.full_name || user.username)+'&background=random'" class="h-28 w-28 rounded-full object-cover border-4 border-slate-100 shadow-lg">
                        </div>
                    </div>
                    <input v-model="profileForm.full_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full p-4 bg-slate-50 rounded-2xl text-base border border-slate-200 outline-none focus:ring-2 focus:ring-purple-200">
                    <div class="border-t pt-4">
                        <label class="text-sm text-slate-400 mb-2 block">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)</label>
                        <input v-model="profileForm.new_password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" class="w-full p-4 bg-slate-50 rounded-2xl text-base border border-slate-200 outline-none focus:ring-2 focus:ring-purple-200">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" @click="showEditProfileModal = false" class="flex-1 bg-slate-100 py-3 rounded-2xl text-base font-bold hover:bg-slate-200 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="flex-1 btn-luxury py-3 rounded-2xl text-base font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>

        <div v-if="showAddMemberModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl animate-fade-in-up">
                <h3 class="text-2xl font-bold mb-6 text-slate-800">{{ memberForm.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å' }}</h3>
                <form @submit.prevent="saveMember" class="space-y-4">
                    <div v-if="user.role === 'admin'"><label class="text-sm font-bold text-slate-400 ml-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ</label><select v-model="memberForm.target_color" class="w-full bg-slate-50 p-4 rounded-2xl text-base outline-none"><option value="purple">‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á</option><option value="skyblue">‡∏™‡∏µ‡∏ü‡πâ‡∏≤</option><option value="blue">‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option><option value="green">‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</option><option value="orange">‡∏™‡∏µ‡πÅ‡∏™‡∏î</option><option value="yellow">‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á</option></select></div>
                    <select v-model="memberForm.department" class="w-full p-4 bg-slate-50 rounded-2xl text-base outline-none border border-slate-100" required><option value="" disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option><option v-for="dept in currentDepartmentOptions" :value="dept">{{ dept }}</option></select>
                    <input v-model="memberForm.name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full p-4 bg-slate-50 rounded-2xl text-base outline-none border border-slate-100" required>
                    <input v-model="memberForm.student_id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" class="w-full p-4 bg-slate-50 rounded-2xl text-base outline-none border border-slate-100">
                    <div class="flex gap-3">
                        <select v-model="memberForm.level" class="w-1/3 p-4 bg-slate-50 rounded-2xl text-base outline-none border border-slate-100"><option v-for="l in formLevels" :value="l.id">{{ l.name }}</option></select>
                        <select v-model="memberForm.room" class="w-1/3 p-4 bg-slate-50 rounded-2xl text-base outline-none border border-slate-100"><option value="" disabled>‡∏´‡πâ‡∏≠‡∏á</option><option v-for="n in 10" :key="n" :value="n">{{ n }}</option><option value="-">-</option></select>
                        <select v-model="memberForm.shirt_size" class="w-1/3 p-4 bg-slate-50 rounded-2xl text-base outline-none border border-slate-100"><option value="SS">SS</option><option value="S">S</option><option value="M">M</option><option value="L">L</option><option value="XL">XL</option><option value="2XL">2XL</option><option value="3XL">3XL</option><option value="4XL">4XL</option><option value="5XL">5XL</option><option value="6XL">6XL</option></select>
                    </div>
                    
                    <div class="flex gap-4 pt-2">
                        <label class="flex items-center gap-2 cursor-pointer bg-green-50 p-3 rounded-xl border border-green-100 flex-1 justify-center hover:bg-green-100 transition">
                            <input type="checkbox" v-model="memberForm.is_paid" class="w-5 h-5 text-green-600 rounded">
                            <span class="text-sm font-bold text-green-700">üí∞ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-blue-50 p-3 rounded-xl border border-blue-100 flex-1 justify-center hover:bg-blue-100 transition">
                            <input type="checkbox" v-model="memberForm.is_received" class="w-5 h-5 text-blue-600 rounded">
                            <span class="text-sm font-bold text-blue-700">üëï ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠</span>
                        </label>
                    </div>

                    <div class="flex gap-3 pt-4"><button type="button" @click="showAddMemberModal = false" class="flex-1 bg-slate-100 py-3 rounded-2xl text-base font-bold text-slate-600 hover:bg-slate-200 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="flex-1 btn-luxury py-3 rounded-2xl text-base font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                </form>
            </div>
        </div>

        <div v-if="showTransactionModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl animate-fade-in-up">
                <h3 class="text-2xl font-bold mb-6 text-slate-800">{{ transactionMode === 'edit' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : (transactionMode === 'set_balance' ? '‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£') }}</h3>
                <form @submit.prevent="saveTransaction" class="space-y-5">
                    <div v-if="user.role === 'admin' && transactionMode === 'new'"><label class="text-sm font-bold text-slate-400 ml-1">‡∏Ç‡∏≠‡∏á‡∏™‡∏µ</label><select v-model="transactionForm.target_color" class="w-full p-4 bg-slate-50 rounded-2xl text-base outline-none"><option value="purple">‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á</option><option value="skyblue">‡∏™‡∏µ‡∏ü‡πâ‡∏≤</option><option value="blue">‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option><option value="green">‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</option><option value="orange">‡∏™‡∏µ‡πÅ‡∏™‡∏î</option><option value="yellow">‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á</option></select></div>
                    <input v-model="transactionForm.description" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏™‡∏µ, ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå)" class="w-full p-4 bg-slate-50 rounded-2xl text-base outline-none border border-slate-100" required :disabled="transactionMode === 'set_balance'">
                    <div class="flex gap-3">
                        <input v-model="transactionForm.amount" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="w-2/3 p-4 bg-slate-50 rounded-2xl text-base outline-none border border-slate-100" required>
                        <select v-model="transactionForm.type" class="w-1/3 p-4 bg-slate-50 rounded-2xl text-base outline-none border border-slate-100" :disabled="transactionMode === 'set_balance'">
                            <option value="income">‡∏£‡∏±‡∏ö (+)</option>
                            <option value="expense" :disabled="!canWithdraw">‡∏à‡πà‡∏≤‡∏¢ (-)</option>
                        </select>
                    </div>
                    
                    <div v-if="!canWithdraw && transactionForm.type !== 'expense'" class="bg-yellow-50 text-yellow-800 p-3 rounded-xl text-sm border border-yellow-100">
                        ‚ö†Ô∏è ‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢ (Expense) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á <b>‡πÄ‡∏´‡∏£‡∏±‡∏ç‡∏ç‡∏¥‡∏Å</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                    </div>

                    <div class="border-t pt-4 border-dashed border-slate-200">
                        <label class="text-sm text-red-500 font-bold block mb-2 flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                        <input v-model="transactionForm.confirm_password" type="password" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="w-full p-4 bg-red-50 border border-red-100 rounded-2xl text-base outline-none focus:ring-2 focus:ring-red-200" required>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" @click="showTransactionModal = false" class="flex-1 bg-slate-100 py-3 rounded-2xl text-base font-bold text-slate-600 hover:bg-slate-200 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="flex-1 btn-luxury py-3 rounded-2xl text-base font-bold shadow-lg">{{ transactionMode === 'edit' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' }}</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

   <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        // üü¢ URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyDL_PJ2Db4E8AczoG1xA0TRfcJSXhIfXw2cEjd2RhGsenFFWdEXGC382kUv3wopiPS/exec'; 

        createApp({
            setup() {
                const token = ref(localStorage.getItem('token') || '');
                const user = ref(JSON.parse(localStorage.getItem('user') || '{}'));
                const isLoginMode = ref(true);
                const currentTab = ref('members');
                const showAddMemberModal = ref(false);
                const showTransactionModal = ref(false);
                const showEditProfileModal = ref(false); 
                const showProfileMenu = ref(false); 
                const transactionMode = ref('new');
                const members = ref([]);
                const budgetList = ref([]); 
                const userList = ref([]);
                const levelFilter = ref('all');
                const adminFilterColor = ref('all');

                const authForm = ref({ username: '', password: '', full_name: '', color: '', role: '' });
                const memberForm = ref({ id: null, name: '', student_id: '', level: '‡∏õ‡∏ß‡∏ä. 1', room: '', shirt_size: 'M', target_color: 'purple', department: '', is_paid: false, is_received: false });
                const transactionForm = ref({ id: null, description: '', amount: '', type: 'expense', target_color: 'purple', confirm_password: '' });
                const profileForm = ref({ full_name: '', new_password: '' });

                const levels = [ 
                    { id: '‡∏õ‡∏ß‡∏ä. 1', name: '‡∏õ‡∏ß‡∏ä. 1' }, 
                    { id: '‡∏õ‡∏ß‡∏ä. 2', name: '‡∏õ‡∏ß‡∏ä. 2' }, 
                    { id: '‡∏õ‡∏ß‡∏ä. 3', name: '‡∏õ‡∏ß‡∏ä. 3' }, 
                    { id: '‡∏õ‡∏ß‡∏™. 1', name: '‡∏õ‡∏ß‡∏™. 1' }, 
                    { id: '‡∏õ‡∏ß‡∏™. 2', name: '‡∏õ‡∏ß‡∏™. 2' },
                    { id: '‡∏õ.‡∏ï‡∏£‡∏µ', name: '‡∏õ.‡∏ï‡∏£‡∏µ' },
                    { id: '‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£', name: '‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£' }
                ];

                const departments = {
                    orange: ['‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£', '‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'], 
                    green: ['‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå', '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®', '‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'], 
                    purple: ['‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏ê‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß', '‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡πÑ‡∏°‡∏ã‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ó‡πå', '‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', '‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'],
                    skyblue: ['‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå', '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•', '‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°', '‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'], 
                    blue: ['‡∏ä‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á', '‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î', '‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'], 
                    yellow: ['‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°', '‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏•', '‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£']
                };

                const normalizeLevel = (input) => {
                    if (!input) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const clean = input.toString().replace(/\s+/g, '').toLowerCase();
                    if (clean === 'voc1' || clean === '‡∏õ‡∏ß‡∏ä.1') return '‡∏õ‡∏ß‡∏ä. 1';
                    if (clean === 'voc2' || clean === '‡∏õ‡∏ß‡∏ä.2') return '‡∏õ‡∏ß‡∏ä. 2';
                    if (clean === 'voc3' || clean === '‡∏õ‡∏ß‡∏ä.3') return '‡∏õ‡∏ß‡∏ä. 3';
                    if (clean === 'hvoc1' || clean === 'dip1' || clean === '‡∏õ‡∏ß‡∏™.1') return '‡∏õ‡∏ß‡∏™. 1';
                    if (clean === 'hvoc2' || clean === 'dip2' || clean === '‡∏õ‡∏ß‡∏™.2') return '‡∏õ‡∏ß‡∏™. 2';
                    if (clean === '‡∏õ.‡∏ï‡∏£‡∏µ' || clean === '‡∏õ‡∏ï‡∏£‡∏µ') return '‡∏õ.‡∏ï‡∏£‡∏µ';
                    return input; 
                };

                const visibleFilterLevels = computed(() => {
                    const contextColor = user.value.role === 'admin' ? adminFilterColor.value : user.value.color;
                    const colorStr = (contextColor || '').toLowerCase();
                    if (colorStr === 'yellow' || colorStr === 'all') return levels;
                    return levels.filter(l => l.id !== '‡∏õ.‡∏ï‡∏£‡∏µ');
                });

                const formLevels = computed(() => {
                    let target = user.value.role === 'admin' ? memberForm.value.target_color : user.value.color;
                    const colorStr = (target || '').toLowerCase();
                    if (colorStr === 'yellow') return levels;
                    return levels.filter(l => l.id !== '‡∏õ.‡∏ï‡∏£‡∏µ');
                });

                const currentDepartmentOptions = computed(() => {
                    let color = user.value.color;
                    if (user.value.role === 'admin') color = memberForm.value.target_color || 'purple';
                    const safeColor = (color || '').toLowerCase();
                    return departments[safeColor] || [];
                });

                // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å form.value ‡πÄ‡∏õ‡πá‡∏ô memberForm.value
                const isStaff = computed(() => memberForm.value.department === '‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£');

                // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å form.value ‡πÄ‡∏õ‡πá‡∏ô memberForm.value
                watch(isStaff, (newVal) => {
                    if (newVal) {
                        memberForm.value.level = '‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£';
                        memberForm.value.room = '-';
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Staff ‡πÅ‡∏ï‡πà level ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô Staff ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                        if (memberForm.value.level === '‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£') {
                            memberForm.value.level = '‡∏õ‡∏ß‡∏ä. 1';
                            memberForm.value.room = ''; 
                        }
                    }
                });

                const canEditMembers = computed(() => ['president', 'vice', 'treasurer', 'admin'].includes(user.value.role));
                const canAccessBudget = computed(() => ['president', 'vice', 'treasurer', 'admin'].includes(user.value.role));
                const canManageBudget = computed(() => ['treasurer', 'admin'].includes(user.value.role));
                const canSetBudget = computed(() => ['treasurer', 'admin'].includes(user.value.role));
                const canWithdraw = computed(() => ['treasurer', 'admin'].includes(user.value.role));
                const getDeptOptions = (c) => departments[c] || [];

                const callSheet = async (action, payload = {}) => {
                    try {
                        const response = await axios.post(GOOGLE_SCRIPT_URL, JSON.stringify({ action, ...payload }), {
                            headers: { "Content-Type": "text/plain" }
                        });
                        return response.data;
                    } catch (error) {
                        console.error("API Error:", error);
                        return { status: 'error', message: 'Connection Failed' };
                    }
                };

                const authAction = async () => {
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    const action = isLoginMode.value ? 'login' : 'register';
                    const res = await callSheet(action, authForm.value);

                    if (res && res.status === 'success') {
                        if (isLoginMode.value) {
                            token.value = 'mock-token';
                            user.value = res.user;
                            localStorage.setItem('token', token.value);
                            localStorage.setItem('user', JSON.stringify(res.user));
                            await fetchData(true); 
                            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        } else {
                            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'success');
                            isLoginMode.value = true;
                            authForm.value = { username: '', password: '', full_name: '', color: '', role: '' };
                        }
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res ? res.message : '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏', 'error');
                    }
                };

                const fetchData = async (showLoading = false) => {
                    if (!token.value) return;

                    if(showLoading) {
                        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    }

                    try {
                        const [resM, resB] = await Promise.all([
                            callSheet('getMembers'),
                            callSheet('getBudget')
                        ]);

                        let filtered = Array.isArray(resM) ? resM : [];
                        filtered = filtered.map(m => {
                            if ((!m.color || m.color.trim() === '') && m.department) {
                                for (const [col, deptList] of Object.entries(departments)) {
                                    if (deptList.includes(m.department)) {
                                        m.color = col; 
                                        break;
                                    }
                                }
                            }
                            if(m.color) m.color = m.color.toLowerCase().trim();
                            return m;
                        });

                        if(user.value.role !== 'admin') {
                            const userColor = (user.value.color || '').toLowerCase().trim();
                            filtered = filtered.filter(m => (m.color || '') === userColor);
                        }
                        if(user.value.role === 'admin' && adminFilterColor.value !== 'all') {
                            const adminTargetColor = (adminFilterColor.value || '').toLowerCase().trim();
                            filtered = filtered.filter(m => (m.color || '') === adminTargetColor);
                        }
                        members.value = filtered;

                        let filteredB = Array.isArray(resB) ? resB : [];
                        if(user.value.role !== 'admin') {
                            const userColor = (user.value.color || '').toLowerCase().trim();
                            filteredB = filteredB.filter(b => (b.color || '').toLowerCase().trim() === userColor);
                        }
                        budgetList.value = filteredB;
                    } finally {
                        if(showLoading) Swal.close();
                    }
                };

                const filteredMembers = computed(() => {
                    let res = members.value;
                    if (levelFilter.value !== 'all') {
                        res = res.filter(m => normalizeLevel(m.level) === levelFilter.value);
                    }
                    return res;
                });

                const saveMember = async () => {
                      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                      const payload = { ...memberForm.value, user_id: user.value.id };
                      await callSheet('saveMember', payload);
                      showAddMemberModal.value = false;
                      await fetchData(false);
                      Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                };

                const openAddMember = () => {
                    const defaultColor = user.value.role === 'admin' ? 'purple' : user.value.color;
                    memberForm.value = { id: null, name: '', student_id: '', level: '‡∏õ‡∏ß‡∏ä. 1', room: '', shirt_size: 'M', target_color: defaultColor, department: '', is_paid: false, is_received: false };
                    showAddMemberModal.value = true;
                };

                const openEditMember = (member) => {
                    memberForm.value = { ...member, is_paid: !!member.is_paid, is_received: !!member.is_received }; 
                    memberForm.value.level = normalizeLevel(member.level);
                    showAddMemberModal.value = true;
                };

                const deleteMember = async (id) => {
                      const { value: password } = await Swal.fire({
                          title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö',
                          text: "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ",
                          input: 'password',
                          inputPlaceholder: '‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
                          icon: 'warning',
                          showCancelButton: true,
                          confirmButtonColor: '#d33',
                          cancelButtonColor: '#3085d6',
                          confirmButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                          inputValidator: (value) => {
                              if (!value) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                          }
                      });

                      if (password) {
                          Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                          await callSheet('deleteMember', { id, confirm_password: password, user_id: user.value.id });
                          await fetchData(false);
                          Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                      }
                };

                const openTransactionModal = (mode, data = null) => {
                    transactionMode.value = mode;
                    const defaultColor = user.value.role === 'admin' ? 'purple' : user.value.color;
                    transactionForm.value = { description: '', amount: '', type: 'expense', target_color: defaultColor, confirm_password: '' };
                    
                    if (mode === 'edit' && data) {
                        transactionForm.value = { ...data, confirm_password: '' };
                    } else if (mode === 'set_balance') { 
                        transactionForm.value.description = '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤ (‡∏á‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)'; 
                        transactionForm.value.type = 'income'; 
                    } else if (mode === 'new') {
                        if (!canWithdraw.value) transactionForm.value.type = 'income';
                    }
                    showTransactionModal.value = true;
                };

                const saveTransaction = async () => {
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    const payload = { ...transactionForm.value, user_id: user.value.id };
                    await callSheet('saveTransaction', payload);
                    showTransactionModal.value = false;
                    await fetchData(false);
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                };

                const deleteTransaction = async (id) => {
                      const { value: password } = await Swal.fire({
                          title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö',
                          text: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà",
                          input: 'password',
                          inputPlaceholder: '‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
                          icon: 'warning',
                          showCancelButton: true,
                          confirmButtonColor: '#d33',
                          cancelButtonColor: '#3085d6',
                          confirmButtonText: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                          inputValidator: (value) => {
                              if (!value) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                          }
                      });

                      if(password) {
                        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                        await callSheet('deleteTransaction', { id, confirm_password: password, user_id: user.value.id });
                        await fetchData(false);
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                      }
                };

                const logout = () => {
                    token.value = '';
                    localStorage.clear();
                };

                const confirmLogout = () => {
                    Swal.fire({ title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?', icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' }).then((result) => { if (result.isConfirmed) logout(); });
                };

                const openEditProfile = () => {
                    profileForm.value = { full_name: user.value.name, new_password: '' };
                    showEditProfileModal.value = true;
                    showProfileMenu.value = false;
                };

                const updateProfile = async () => {
                      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                      const payload = { ...profileForm.value, id: user.value.id };
                      await callSheet('updateProfile', payload);
                      user.value.full_name = profileForm.value.full_name;
                      localStorage.setItem('user', JSON.stringify(user.value));
                      showEditProfileModal.value = false;
                      Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                };

                const resetPassword = async (id, username) => {
                    const { value: newPassword } = await Swal.fire({ title: `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á: ${username}`, input: 'text', inputLabel: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà', showCancelButton: true });
                    if (newPassword) {
                         Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                         await callSheet('updateProfile', { id: id, new_password: newPassword });
                         Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    }
                };

                const importExcel = async (event) => { console.log('Import removed'); };

                 const groupedMembers = computed(() => {
                    const groups = {};
                    filteredMembers.value.forEach(m => {
                        const dept = m.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        const levelName = normalizeLevel(m.level); 
                        const roomKey = `${levelName} ‡∏´‡πâ‡∏≠‡∏á ${m.room}`;
                        
                        if(!groups[dept]) groups[dept] = {};
                        if(!groups[dept][roomKey]) groups[dept][roomKey] = [];
                        groups[dept][roomKey].push(m);
                    });
                    return groups;
                });

                const totalIncome = computed(() => budgetList.value.filter(b => b.type === 'income').reduce((sum, b) => sum + Number(b.amount), 0));
                const totalExpense = computed(() => budgetList.value.filter(b => b.type === 'expense').reduce((sum, b) => sum + Number(b.amount), 0));

                const generateSummary = () => {
                    const summary = {};
                    filteredMembers.value.forEach(m => {
                        const dept = m.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å';
                        const lvlName = normalizeLevel(m.level); 
                        const roomName = m.room ? `‡∏´‡πâ‡∏≠‡∏á ${m.room}` : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡πâ‡∏≠‡∏á';

                        if (!summary[dept]) summary[dept] = {};
                        if (!summary[dept][lvlName]) summary[dept][lvlName] = {};
                        if (!summary[dept][lvlName][roomName]) summary[dept][lvlName][roomName] = { S:0, M:0, L:0, XL:0, '2XL':0, '3XL':0, '4XL':0, Total:0 };

                        if (summary[dept][lvlName][roomName][m.shirt_size] !== undefined) {
                            summary[dept][lvlName][roomName][m.shirt_size]++;
                            summary[dept][lvlName][roomName].Total++;
                        }
                    });

                    let html = '<div class="overflow-y-auto max-h-[60vh] text-left text-sm">';

                    for (const [dept, levels] of Object.entries(summary)) {
                        html += `<h3 class="font-bold text-base mt-4 mb-2 bg-slate-100 p-2 rounded text-slate-700 border-l-4 border-purple-500">${dept}</h3>`;
                        for (const [lvl, rooms] of Object.entries(levels)) {
                            html += `<h4 class="font-bold text-slate-600 mt-2 ml-2 text-xs bg-slate-50 p-1 rounded inline-block border border-slate-200">${lvl}</h4>`;
                            html += `<table class="w-full border-collapse border border-slate-200 mt-1 mb-3 text-center text-xs">`;
                            html += `<thead class="bg-slate-50"><tr><th class="border p-1">‡∏´‡πâ‡∏≠‡∏á</th><th class="border p-1">S</th><th class="border p-1">M</th><th class="border p-1">L</th><th class="border p-1">XL</th><th class="border p-1">2XL</th><th class="border p-1">3XL</th><th class="border p-1">4XL</th><th class="border p-1 bg-purple-50 font-bold">‡∏£‡∏ß‡∏°</th></tr></thead><tbody>`;

                            for (const [room, sizes] of Object.entries(rooms)) {
                                html += `<tr><td class="border p-1 font-medium text-left pl-2">${room}</td>`;
                                html += `<td class="border p-1">${sizes.S}</td><td class="border p-1">${sizes.M}</td><td class="border p-1">${sizes.L}</td><td class="border p-1">${sizes.XL}</td>`;
                                html += `<td class="border p-1">${sizes['2XL']}</td><td class="border p-1">${sizes['3XL']}</td><td class="border p-1">${sizes['4XL']}</td>`;
                                html += `<td class="border p-1 font-bold bg-purple-50">${sizes.Total}</td></tr>`;
                            }
                            html += `</tbody></table>`;
                        }
                    }
                    html += '</div>';

                    if (Object.keys(summary).length === 0) html = '<p class="text-center p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>';

                    Swal.fire({ 
                        title: '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏™‡∏∑‡πâ‡∏≠', 
                        html: html, 
                        width: '800px', 
                        confirmButtonText: '‡∏õ‡∏¥‡∏î', 
                        customClass: { popup: 'rounded-2xl' }
                    });
                };

                const getNavbarClass = (c) => ({ admin: 'theme-admin', purple: 'theme-purple', skyblue: 'theme-skyblue', blue: 'theme-blue', green: 'theme-green', orange: 'theme-orange', yellow: 'theme-yellow' }[c] || 'theme-admin');
                const getColorName = (c) => ({ purple: '‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á', skyblue: '‡∏™‡∏µ‡∏ü‡πâ‡∏≤', blue: '‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', green: '‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', orange: '‡∏™‡∏µ‡πÅ‡∏™‡∏î', yellow: '‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', admin: '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á' }[c] || c);
                const getRoleName = (r) => ({ president: '‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô', vice: '‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô', treasurer: '‡πÄ‡∏´‡∏£‡∏±‡∏ç‡∏ç‡∏¥‡∏Å', staff: 'Staff', admin: 'Admin' }[r] || r);
                const getBadgeClass = (c) => ({ purple: 'badge-purple', skyblue: 'badge-skyblue', blue: 'badge-blue', green: 'badge-green', orange: 'badge-orange', yellow: 'badge-yellow', admin: 'badge-admin' }[c] || 'bg-gray-100');
                const formatCurrency = (val) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(val);

                const loadUsers = async () => {
                    currentTab.value = 'users';
                    const res = await callSheet('getUsers');
                    userList.value = res;
                };

                const showSizeChart = () => {
                    Swal.fire({
                        imageUrl: 'size_chart.jpg', 
                        imageAlt: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏ã‡∏™‡πå‡πÄ‡∏™‡∏∑‡πâ‡∏≠',
                        showCloseButton: true,
                        showConfirmButton: false,
                        width: 'auto',
                        padding: '1rem', 
                        customClass: {
                            popup: 'rounded-[2rem]',
                            image: 'rounded-xl mt-2 w-auto h-auto max-h-[75vh] mx-auto object-contain shadow-sm' 
                        }
                    });
                };

                const confirmBulkPay = async (targetMembers, isChecked) => {
                    if (!isChecked) return; 
                    
                    const toPay = targetMembers.filter(m => !m.is_paid);
                    if (toPay.length === 0) {
                        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'info');
                        return;
                    }

                    const result = await Swal.fire({
                        title: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô ${toPay.length} ‡∏Ñ‡∏ô?`,
                        text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                    });

                    if (result.isConfirmed) {
                        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                        
                        let successCount = 0;
                        for (const member of toPay) {
                            try {
                                await callSheet('saveMember', { ...member, is_paid: true, user_id: user.value.id });
                                successCount++;
                            } catch (e) {
                                console.error(e);
                            }
                        }
                        
                        await fetchData(false);
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${successCount} ‡∏Ñ‡∏ô`, 'success');
                    } else {
                        await fetchData(false);
                    }
                };

                const confirmBulkPayObj = (roomsObj, isChecked) => {
                    const allMembers = Object.values(roomsObj).flat();
                    confirmBulkPay(allMembers, isChecked);
                };

                onMounted(() => fetchData(true)); 

                return {
                    token, user, isLoginMode, currentTab, members, authForm, memberForm, transactionForm, profileForm,
                    budgetList, 
                    authAction, logout, groupedMembers,
                    deleteMember, deleteTransaction, saveMember, saveTransaction, openAddMember, openEditMember, openTransactionModal, 
                    confirmLogout, openEditProfile, updateProfile, resetPassword, 
                    importExcel, fetchData, generateSummary, loadUsers, adminFilterColor, currentDepartmentOptions,
                    canEditMembers, canAccessBudget, canManageBudget, canSetBudget, canWithdraw, totalIncome, totalExpense,
                    userList, levels, levelFilter, filteredMembers,
                    getNavbarClass, getColorName, getRoleName, getBadgeClass, formatCurrency,
                    showAddMemberModal, showTransactionModal, showEditProfileModal, showProfileMenu, transactionMode,
                    confirmBulkPay, confirmBulkPayObj,
                    visibleFilterLevels, formLevels, showSizeChart, isStaff
                };
            }
        }).mount('#app');
    </script>
</body>
</html>



